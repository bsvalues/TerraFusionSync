<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>System Metrics Dashboard - TerraFusion SyncService</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.8.0/font/bootstrap-icons.css" rel="stylesheet">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-annotation@2.1.0/dist/chartjs-plugin-annotation.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-datalabels@2.0.0"></script>
    <style>
        .metric-card {
            transition: transform 0.2s;
        }
        .metric-card:hover {
            transform: translateY(-5px);
        }
        .value-up {
            color: #198754;
        }
        .value-down {
            color: #dc3545;
        }
        .alert-indicator {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            display: inline-block;
            margin-right: 5px;
        }
        .alert-normal {
            background-color: #20c997;
        }
        .alert-warning {
            background-color: #ffc107;
        }
        .alert-critical {
            background-color: #dc3545;
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark">
        <div class="container-fluid">
            <a class="navbar-brand" href="/">
                <i class="bi bi-arrow-repeat me-2"></i>
                TerraFusion SyncService
            </a>
            <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
                <span class="navbar-toggler-icon"></span>
            </button>
            <div class="collapse navbar-collapse" id="navbarNav">
                <ul class="navbar-nav">
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard">Dashboard</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard/sync">Sync Operations</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link active" href="/dashboard/metrics">Metrics</a>
                    </li>
                    <li class="nav-item">
                        <a class="nav-link" href="/dashboard/audit">Audit Trail</a>
                    </li>
                </ul>
                <ul class="navbar-nav ms-auto">
                    {% if user %}
                    <li class="nav-item dropdown">
                        <a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
                            <i class="bi bi-person-circle me-1"></i>
                            {{ user.name }}
                        </a>
                        <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="navbarDropdown">
                            <li><a class="dropdown-item" href="/profile">Profile</a></li>
                            <li><hr class="dropdown-divider"></li>
                            <li><a class="dropdown-item" href="/logout">Logout</a></li>
                        </ul>
                    </li>
                    {% else %}
                    <li class="nav-item">
                        <a class="nav-link" href="/login">Login</a>
                    </li>
                    {% endif %}
                </ul>
            </div>
        </div>
    </nav>

    <!-- Toast container for notifications -->
    <div class="toast-container position-fixed top-0 end-0 p-3" style="z-index: 1100;">
        <div id="metricsToast" class="toast" role="alert" aria-live="assertive" aria-atomic="true">
            <div class="toast-header">
                <i class="bi bi-info-circle me-1 text-primary" id="toast-icon"></i>
                <strong class="me-auto" id="toast-title">Metrics Status</strong>
                <small id="toast-time">Just now</small>
                <button type="button" class="btn-close" data-bs-dismiss="toast" aria-label="Close"></button>
            </div>
            <div class="toast-body" id="toast-message">
                Metrics information will appear here.
            </div>
        </div>
    </div>

    <div class="container-fluid py-4">
        <div class="row mb-4">
            <div class="col">
                <h1 class="h3">System Metrics</h1>
                <p class="text-muted">Real-time performance monitoring of the TerraFusion platform</p>
            </div>
            <div class="col-auto">
                <div class="btn-group" role="group">
                    <button type="button" class="btn btn-outline-secondary">
                        <i class="bi bi-download me-1"></i>Export
                    </button>
                    <button type="button" class="btn btn-outline-secondary" id="refresh-metrics">
                        <i class="bi bi-arrow-clockwise me-1"></i>Refresh
                    </button>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="display-4 text-primary mb-2">
                            {% if system_metrics and system_metrics|length > 0 %}
                                {{ system_metrics[0].cpu_usage|round(1) }}%
                            {% else %}
                                --.--%
                            {% endif %}
                        </div>
                        <h5 class="card-title mb-0">CPU Usage</h5>
                        <p class="text-muted small">Current system processor usage</p>
                        {% if system_metrics and system_metrics|length > 1 %}
                            {% if system_metrics[0].cpu_usage > system_metrics[1].cpu_usage %}
                                <div class="small value-up"><i class="bi bi-arrow-up-right"></i> {{ ((system_metrics[0].cpu_usage - system_metrics[1].cpu_usage) / system_metrics[1].cpu_usage * 100)|round(1) }}% from previous</div>
                            {% else %}
                                <div class="small value-down"><i class="bi bi-arrow-down-right"></i> {{ ((system_metrics[1].cpu_usage - system_metrics[0].cpu_usage) / system_metrics[1].cpu_usage * 100)|round(1) }}% from previous</div>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress" style="height: 5px;">
                            {% if system_metrics and system_metrics|length > 0 %}
                                <div class="progress-bar {% if system_metrics[0].cpu_usage > 80 %}bg-danger{% elif system_metrics[0].cpu_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ system_metrics[0].cpu_usage }}%"></div>
                            {% else %}
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="display-4 text-primary mb-2">
                            {% if system_metrics and system_metrics|length > 0 %}
                                {{ system_metrics[0].memory_usage|round(1) }}%
                            {% else %}
                                --.--%
                            {% endif %}
                        </div>
                        <h5 class="card-title mb-0">Memory Usage</h5>
                        <p class="text-muted small">Current RAM utilization</p>
                        {% if system_metrics and system_metrics|length > 1 %}
                            {% if system_metrics[0].memory_usage > system_metrics[1].memory_usage %}
                                <div class="small value-up"><i class="bi bi-arrow-up-right"></i> {{ ((system_metrics[0].memory_usage - system_metrics[1].memory_usage) / system_metrics[1].memory_usage * 100)|round(1) }}% from previous</div>
                            {% else %}
                                <div class="small value-down"><i class="bi bi-arrow-down-right"></i> {{ ((system_metrics[1].memory_usage - system_metrics[0].memory_usage) / system_metrics[1].memory_usage * 100)|round(1) }}% from previous</div>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress" style="height: 5px;">
                            {% if system_metrics and system_metrics|length > 0 %}
                                <div class="progress-bar {% if system_metrics[0].memory_usage > 80 %}bg-danger{% elif system_metrics[0].memory_usage > 60 %}bg-warning{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ system_metrics[0].memory_usage }}%"></div>
                            {% else %}
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="display-4 text-primary mb-2">
                            {% if system_metrics and system_metrics|length > 0 %}
                                {{ system_metrics[0].disk_usage|round(1) }}%
                            {% else %}
                                --.--%
                            {% endif %}
                        </div>
                        <h5 class="card-title mb-0">Disk Usage</h5>
                        <p class="text-muted small">Storage space utilization</p>
                        {% if system_metrics and system_metrics|length > 1 %}
                            {% if system_metrics[0].disk_usage > system_metrics[1].disk_usage %}
                                <div class="small value-up"><i class="bi bi-arrow-up-right"></i> {{ ((system_metrics[0].disk_usage - system_metrics[1].disk_usage) / system_metrics[1].disk_usage * 100)|round(1) }}% from previous</div>
                            {% else %}
                                <div class="small value-down"><i class="bi bi-arrow-down-right"></i> {{ ((system_metrics[1].disk_usage - system_metrics[0].disk_usage) / system_metrics[1].disk_usage * 100)|round(1) }}% from previous</div>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress" style="height: 5px;">
                            {% if system_metrics and system_metrics|length > 0 %}
                                <div class="progress-bar {% if system_metrics[0].disk_usage > 85 %}bg-danger{% elif system_metrics[0].disk_usage > 70 %}bg-warning{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ system_metrics[0].disk_usage }}%"></div>
                            {% else %}
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
            <div class="col-md-3">
                <div class="card metric-card h-100">
                    <div class="card-body text-center">
                        <div class="display-4 text-primary mb-2">
                            {% if system_metrics and system_metrics|length > 0 %}
                                {{ system_metrics[0].response_time|round(2) }}s
                            {% else %}
                                -.-s
                            {% endif %}
                        </div>
                        <h5 class="card-title mb-0">Response Time</h5>
                        <p class="text-muted small">Average API response latency</p>
                        {% if system_metrics and system_metrics|length > 1 and system_metrics[1].response_time > 0 %}
                            {% if system_metrics[0].response_time > system_metrics[1].response_time %}
                                <div class="small value-up"><i class="bi bi-arrow-up-right"></i> {{ ((system_metrics[0].response_time - system_metrics[1].response_time) / system_metrics[1].response_time * 100)|round(1) }}% from previous</div>
                            {% elif system_metrics[1].response_time > system_metrics[0].response_time %}
                                <div class="small value-down"><i class="bi bi-arrow-down-right"></i> {{ ((system_metrics[1].response_time - system_metrics[0].response_time) / system_metrics[1].response_time * 100)|round(1) }}% from previous</div>
                            {% else %}
                                <div class="small text-muted">No change from previous</div>
                            {% endif %}
                        {% endif %}
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="progress" style="height: 5px;">
                            {% if system_metrics and system_metrics|length > 0 %}
                                <div class="progress-bar {% if system_metrics[0].response_time > 2.0 %}bg-danger{% elif system_metrics[0].response_time > 1.0 %}bg-warning{% else %}bg-success{% endif %}" role="progressbar" style="width: {{ (system_metrics[0].response_time / 5.0 * 100)|round(0) }}%"></div>
                            {% else %}
                                <div class="progress-bar bg-secondary" role="progressbar" style="width: 0%"></div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row mb-4">
            <div class="col-lg-8">
                <div class="card">
                    <div class="card-header d-flex justify-content-between align-items-center">
                        <h5 class="mb-0">Historical Performance</h5>
                        <div class="btn-group btn-group-sm" role="group">
                            <button type="button" class="btn btn-outline-secondary active" id="cpu-btn">CPU</button>
                            <button type="button" class="btn btn-outline-secondary" id="memory-btn">Memory</button>
                            <button type="button" class="btn btn-outline-secondary" id="response-btn">Response Time</button>
                        </div>
                    </div>
                    <div class="card-body">
                        <canvas id="metricsChart" height="250"></canvas>
                    </div>
                </div>
            </div>
            <div class="col-lg-4">
                <div class="card h-100">
                    <div class="card-header">
                        <h5 class="mb-0">System Status</h5>
                    </div>
                    <div class="card-body">
                        <ul class="list-group list-group-flush">
                            {% if system_metrics and system_metrics|length > 0 %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator {% if system_metrics[0].cpu_usage < 70 %}alert-normal{% elif system_metrics[0].cpu_usage < 90 %}alert-warning{% else %}alert-critical{% endif %}"></span>
                                        CPU Status
                                    </div>
                                    <span class="badge {% if system_metrics[0].cpu_usage < 70 %}bg-success{% elif system_metrics[0].cpu_usage < 90 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {% if system_metrics[0].cpu_usage < 70 %}Normal{% elif system_metrics[0].cpu_usage < 90 %}Warning{% else %}Critical{% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator {% if system_metrics[0].memory_usage < 70 %}alert-normal{% elif system_metrics[0].memory_usage < 90 %}alert-warning{% else %}alert-critical{% endif %}"></span>
                                        Memory Status
                                    </div>
                                    <span class="badge {% if system_metrics[0].memory_usage < 70 %}bg-success{% elif system_metrics[0].memory_usage < 90 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {% if system_metrics[0].memory_usage < 70 %}Normal{% elif system_metrics[0].memory_usage < 90 %}Warning{% else %}Critical{% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator {% if system_metrics[0].disk_usage < 80 %}alert-normal{% elif system_metrics[0].disk_usage < 90 %}alert-warning{% else %}alert-critical{% endif %}"></span>
                                        Disk Status
                                    </div>
                                    <span class="badge {% if system_metrics[0].disk_usage < 80 %}bg-success{% elif system_metrics[0].disk_usage < 90 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {% if system_metrics[0].disk_usage < 80 %}Normal{% elif system_metrics[0].disk_usage < 90 %}Warning{% else %}Critical{% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator {% if system_metrics[0].response_time < 1.0 %}alert-normal{% elif system_metrics[0].response_time < 2.0 %}alert-warning{% else %}alert-critical{% endif %}"></span>
                                        Response Time
                                    </div>
                                    <span class="badge {% if system_metrics[0].response_time < 1.0 %}bg-success{% elif system_metrics[0].response_time < 2.0 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {% if system_metrics[0].response_time < 1.0 %}Normal{% elif system_metrics[0].response_time < 2.0 %}Warning{% else %}Critical{% endif %}
                                    </span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator {% if system_metrics[0].error_count == 0 %}alert-normal{% elif system_metrics[0].error_count < 5 %}alert-warning{% else %}alert-critical{% endif %}"></span>
                                        Error Rate
                                    </div>
                                    <span class="badge {% if system_metrics[0].error_count == 0 %}bg-success{% elif system_metrics[0].error_count < 5 %}bg-warning{% else %}bg-danger{% endif %}">
                                        {% if system_metrics[0].error_count == 0 %}No Errors{% elif system_metrics[0].error_count < 5 %}{{ system_metrics[0].error_count }} Errors{% else %}Critical{% endif %}
                                    </span>
                                </li>
                            {% else %}
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator alert-normal"></span>
                                        CPU Status
                                    </div>
                                    <span class="badge bg-secondary">No Data</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator alert-normal"></span>
                                        Memory Status
                                    </div>
                                    <span class="badge bg-secondary">No Data</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator alert-normal"></span>
                                        Disk Status
                                    </div>
                                    <span class="badge bg-secondary">No Data</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator alert-normal"></span>
                                        Response Time
                                    </div>
                                    <span class="badge bg-secondary">No Data</span>
                                </li>
                                <li class="list-group-item d-flex justify-content-between align-items-center">
                                    <div>
                                        <span class="alert-indicator alert-normal"></span>
                                        Error Rate
                                    </div>
                                    <span class="badge bg-secondary">No Data</span>
                                </li>
                            {% endif %}
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="alert-indicator alert-normal" id="metrics-collection-indicator"></span>
                                    Metrics Collection
                                </div>
                                <span class="badge bg-success" id="metrics-collection-status">Normal</span>
                            </li>
                            <li class="list-group-item d-flex justify-content-between align-items-center">
                                <div>
                                    <span class="alert-indicator alert-normal" id="syncservice-indicator"></span>
                                    SyncService Status
                                </div>
                                <div class="d-flex align-items-center">
                                    <span class="badge bg-success me-2" id="syncservice-status">Connected</span>
                                    <button class="btn btn-sm btn-outline-primary" id="health-check-btn" title="Run health check and automatically recover service if needed">
                                        <i class="bi bi-wrench-adjustable"></i> Health Check
                                    </button>
                                </div>
                            </li>
                        </ul>
                    </div>
                    <div class="card-footer bg-transparent">
                        <div class="d-flex justify-content-between align-items-center">
                            <small class="text-muted">Last updated: {{ system_metrics[0].timestamp }}</small>
                            <div class="btn-group btn-group-sm">
                                <button class="btn btn-sm btn-outline-primary" id="check-status-btn">Check Status</button>
                                <button class="btn btn-sm btn-outline-success" id="refresh-metrics-btn">Force Refresh</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div class="row">
            <div class="col-lg-12">
                <div class="card">
                    <div class="card-header">
                        <h5 class="mb-0">Recent Metrics Data</h5>
                    </div>
                    <div class="card-body p-0">
                        <div class="table-responsive">
                            <table class="table table-hover table-striped mb-0">
                                <thead>
                                    <tr>
                                        <th>Timestamp</th>
                                        <th>CPU Usage</th>
                                        <th>Memory Usage</th>
                                        <th>Disk Usage</th>
                                        <th>API Requests</th>
                                        <th>Active Syncs</th>
                                        <th>Active Users</th>
                                        <th>Response Time</th>
                                        <th>Error Rate</th>
                                        <th>Health Status</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    {% for metric in system_metrics %}
                                    <tr>
                                        <td>{{ metric.timestamp }}</td>
                                        <td class="{% if metric.cpu_usage > 80 %}text-danger{% elif metric.cpu_usage > 60 %}text-warning{% endif %}">{{ metric.cpu_usage }}%</td>
                                        <td class="{% if metric.memory_usage > 80 %}text-danger{% elif metric.memory_usage > 60 %}text-warning{% endif %}">{{ metric.memory_usage }}%</td>
                                        <td class="{% if metric.disk_usage > 85 %}text-danger{% elif metric.disk_usage > 70 %}text-warning{% endif %}">{{ metric.disk_usage }}%</td>
                                        <td>{{ metric.api_requests }}</td>
                                        <td>{{ metric.active_syncs }}</td>
                                        <td>{{ metric.active_users }}</td>
                                        <td class="{% if metric.average_response_time > 2.0 %}text-danger{% elif metric.average_response_time > 1.0 %}text-warning{% endif %}">{{ metric.average_response_time }}s</td>
                                        <td class="{% if metric.error_rate > 0.05 %}text-danger{% elif metric.error_rate > 0.01 %}text-warning{% endif %}">{{ (metric.error_rate * 100)|round(2) }}%</td>
                                        <td>
                                            <span class="badge {% if metric.syncservice_health == 'healthy' %}bg-success{% elif metric.syncservice_health == 'warning' %}bg-warning{% else %}bg-danger{% endif %}">
                                                {{ metric.syncservice_health|title }}
                                            </span>
                                        </td>
                                    </tr>
                                    {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0-alpha1/dist/js/bootstrap.bundle.min.js"></script>
    <script>
    document.addEventListener('DOMContentLoaded', function() {
        // Register Chart.js plugins
        Chart.register(ChartDataLabels);
        Chart.register(ChartAnnotation);
        
        // Prepare data for charts
        const timestamps = {{ system_metrics|map(attribute='timestamp')|list|tojson }};
        const cpuData = {{ system_metrics|map(attribute='cpu_usage')|list|tojson }};
        const memoryData = {{ system_metrics|map(attribute='memory_usage')|list|tojson }};
        const responseTimeData = {{ system_metrics|map(attribute='average_response_time')|list|tojson }};
        const diskData = {{ system_metrics|map(attribute='disk_usage')|list|tojson }};
        const apiRequestsData = {{ system_metrics|map(attribute='api_requests')|list|tojson }};
        const errorRateData = {{ system_metrics|map(attribute='error_rate')|list|tojson }};
        
        // Collect advanced metrics if available
        const activeSyncsData = {{ system_metrics|map(attribute='active_syncs')|list|tojson }};
        const activeUsersData = {{ system_metrics|map(attribute='active_users')|list|tojson }};
        
        // Reverse arrays to show chronological order (newest data last)
        timestamps.reverse();
        cpuData.reverse();
        memoryData.reverse();
        responseTimeData.reverse();
        diskData.reverse();
        apiRequestsData.reverse();
        errorRateData.reverse();
        activeSyncsData.reverse();
        activeUsersData.reverse();
        
        // Format timestamps for display
        const formattedLabels = timestamps.map(timestamp => {
            const date = new Date(timestamp);
            return date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
        });
        
        // Generate color gradients based on thresholds
        function generateGradient(ctx, metric) {
            // Create gradient based on metric type
            const gradient = ctx.createLinearGradient(0, 0, 0, 400);
            
            if (metric === 'cpu' || metric === 'memory' || metric === 'disk') {
                // Resource usage gradient (green -> yellow -> red)
                gradient.addColorStop(0, 'rgba(220, 53, 69, 0.8)');   // Red (high usage)
                gradient.addColorStop(0.3, 'rgba(255, 193, 7, 0.8)'); // Yellow (medium usage)
                gradient.addColorStop(0.7, 'rgba(25, 135, 84, 0.8)'); // Green (low usage)
                gradient.addColorStop(1, 'rgba(25, 135, 84, 0.1)');   // Transparent green
            } else if (metric === 'response') {
                // Response time gradient (green -> yellow -> red)
                gradient.addColorStop(0, 'rgba(220, 53, 69, 0.8)');   // Red (slow)
                gradient.addColorStop(0.4, 'rgba(255, 193, 7, 0.8)'); // Yellow (medium)
                gradient.addColorStop(0.7, 'rgba(13, 110, 253, 0.8)'); // Blue (fast)
                gradient.addColorStop(1, 'rgba(13, 110, 253, 0.1)');   // Transparent blue
            } else if (metric === 'errors') {
                // Error count gradient (green -> red)
                gradient.addColorStop(0, 'rgba(220, 53, 69, 0.8)');   // Red (many errors)
                gradient.addColorStop(0.5, 'rgba(255, 193, 7, 0.8)'); // Yellow (some errors)
                gradient.addColorStop(0.9, 'rgba(25, 135, 84, 0.8)'); // Green (no errors)
                gradient.addColorStop(1, 'rgba(25, 135, 84, 0.1)');   // Transparent green
            } else {
                // Default gradient (blue)
                gradient.addColorStop(0, 'rgba(13, 110, 253, 0.8)');  // Blue
                gradient.addColorStop(1, 'rgba(13, 110, 253, 0.1)');  // Transparent blue
            }
            
            return gradient;
        }
        
        // Initialize main metrics chart with dynamic color gradient
        const ctx = document.getElementById('metricsChart').getContext('2d');
        
        // Get gradient for CPU usage
        const cpuGradient = generateGradient(ctx, 'cpu');
        
        // Create the chart with enhanced options
        const chart = new Chart(ctx, {
            type: 'line',
            data: {
                labels: formattedLabels,
                datasets: [{
                    label: 'CPU Usage (%)',
                    data: cpuData,
                    borderColor: 'rgba(25, 135, 84, 1)',
                    backgroundColor: cpuGradient,
                    tension: 0.4,
                    borderWidth: 2,
                    pointRadius: 3,
                    pointBackgroundColor: 'rgba(25, 135, 84, 1)',
                    fill: true,
                    cubicInterpolationMode: 'monotone'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false,
                },
                animation: {
                    duration: 1000,
                    easing: 'easeOutQuart'
                },
                scales: {
                    y: {
                        beginAtZero: true,
                        max: 100,
                        title: {
                            display: true,
                            text: 'Percentage'
                        },
                        ticks: {
                            callback: function(value) {
                                return value + '%';
                            }
                        },
                        grid: {
                            color: 'rgba(200, 200, 200, 0.2)'
                        }
                    },
                    x: {
                        title: {
                            display: true,
                            text: 'Time'
                        },
                        grid: {
                            display: false
                        }
                    }
                },
                plugins: {
                    legend: {
                        position: 'top',
                        labels: {
                            usePointStyle: true,
                            padding: 15
                        }
                    },
                    datalabels: {
                        display: function(context) {
                            // Only show labels for every nth point to avoid clutter
                            return context.dataIndex % 3 === 0;
                        },
                        backgroundColor: function(context) {
                            return context.dataset.borderColor;
                        },
                        borderRadius: 4,
                        color: 'white',
                        font: {
                            weight: 'bold',
                            size: 10
                        },
                        padding: 4,
                        formatter: function(value, context) {
                            // Check if we're displaying response time or percentages
                            if (context.dataset.label.includes('Response Time')) {
                                return value.toFixed(2) + 's';
                            } else {
                                return value.toFixed(1) + '%';
                            }
                        }
                    },
                    tooltip: {
                        mode: 'index',
                        intersect: false,
                        backgroundColor: 'rgba(50, 50, 50, 0.9)',
                        titleColor: '#ffffff',
                        bodyColor: '#ffffff',
                        borderColor: 'rgba(255, 255, 255, 0.2)',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: true,
                        callbacks: {
                            label: function(context) {
                                let label = context.dataset.label || '';
                                if (label) {
                                    label += ': ';
                                }
                                // Check if we're displaying response time or percentages
                                if (label.includes('Response Time')) {
                                    label += context.parsed.y.toFixed(2) + 's';
                                } else {
                                    label += context.parsed.y.toFixed(1) + '%';
                                }
                                return label;
                            }
                        }
                    },
                    annotation: {
                        annotations: {
                            warningLine: {
                                type: 'line',
                                yMin: 70,
                                yMax: 70,
                                borderColor: 'rgba(255, 193, 7, 0.8)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    display: true,
                                    content: 'Warning Threshold',
                                    position: 'start',
                                    backgroundColor: 'rgba(255, 193, 7, 0.8)',
                                    color: 'black',
                                    font: {
                                        size: 10
                                    }
                                }
                            },
                            criticalLine: {
                                type: 'line',
                                yMin: 90,
                                yMax: 90,
                                borderColor: 'rgba(220, 53, 69, 0.8)',
                                borderWidth: 2,
                                borderDash: [5, 5],
                                label: {
                                    display: true,
                                    content: 'Critical Threshold',
                                    position: 'start',
                                    backgroundColor: 'rgba(220, 53, 69, 0.8)',
                                    color: 'white',
                                    font: {
                                        size: 10
                                    }
                                }
                            }
                        }
                    }
                }
            }
        });
        
        // Switch between metrics
        document.getElementById('cpu-btn').addEventListener('click', function() {
            const cpuGradient = generateGradient(ctx, 'cpu');
            updateChart('CPU Usage (%)', cpuData, 'rgba(25, 135, 84, 1)', cpuGradient, 'cpu');
            setActiveButton('cpu-btn');
        });
        
        document.getElementById('memory-btn').addEventListener('click', function() {
            const memoryGradient = generateGradient(ctx, 'memory');
            updateChart('Memory Usage (%)', memoryData, 'rgba(13, 110, 253, 1)', memoryGradient, 'memory');
            setActiveButton('memory-btn');
        });
        
        document.getElementById('response-btn').addEventListener('click', function() {
            const responseGradient = generateGradient(ctx, 'response');
            updateChart('Response Time (s)', responseTimeData, 'rgba(153, 102, 255, 1)', responseGradient, 'response');
            setActiveButton('response-btn');
        });
        
        // Enhanced chart update function with threshold annotations
        function updateChart(label, data, borderColor, backgroundColor, metricType) {
            // Update dataset
            chart.data.datasets[0].label = label;
            chart.data.datasets[0].data = data;
            chart.data.datasets[0].borderColor = borderColor;
            chart.data.datasets[0].backgroundColor = backgroundColor;
            chart.data.datasets[0].pointBackgroundColor = borderColor;
            
            // Update Y axis and annotations based on metric type
            if (metricType === 'response') {
                // Response time has different scale and thresholds
                const maxValue = Math.max(...data) * 1.2 || 5.0;
                chart.options.scales.y.max = maxValue;
                chart.options.scales.y.ticks.callback = function(value) {
                    return value + 's';
                };
                
                // Update threshold annotations for response time
                chart.options.plugins.annotation.annotations.warningLine.yMin = 1.0;
                chart.options.plugins.annotation.annotations.warningLine.yMax = 1.0;
                chart.options.plugins.annotation.annotations.criticalLine.yMin = 2.0;
                chart.options.plugins.annotation.annotations.criticalLine.yMax = 2.0;
            } else {
                // CPU, Memory, Disk all use percentage scale
                chart.options.scales.y.max = 100;
                chart.options.scales.y.ticks.callback = function(value) {
                    return value + '%';
                };
                
                // Reset to default threshold annotations
                chart.options.plugins.annotation.annotations.warningLine.yMin = 70;
                chart.options.plugins.annotation.annotations.warningLine.yMax = 70;
                chart.options.plugins.annotation.annotations.criticalLine.yMin = 90;
                chart.options.plugins.annotation.annotations.criticalLine.yMax = 90;
            }
            
            // Apply changes
            chart.update();
        }
        
        function setActiveButton(activeId) {
            ['cpu-btn', 'memory-btn', 'response-btn'].forEach(id => {
                document.getElementById(id).classList.remove('active');
            });
            document.getElementById(activeId).classList.add('active');
        }
        
        // Refresh metrics
        document.getElementById('refresh-metrics').addEventListener('click', function() {
            window.location.reload();
        });
        
        // Check status
        document.getElementById('check-status-btn').addEventListener('click', function() {
            fetchMetricsStatus();
        });
        
        // Fetch metrics status from the API with improved error handling
        function fetchMetricsStatus() {
            // Show loading indicators while fetching
            const metricsStatusElement = document.getElementById('metrics-collection-status');
            const syncStatusElement = document.getElementById('syncservice-status');
            
            // Set loading state
            metricsStatusElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            syncStatusElement.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            
            // Implement fetch with timeout using Promise race
            const fetchWithTimeout = (url, options, timeout = 5000) => {
                return Promise.race([
                    fetch(url, options),
                    new Promise((_, reject) => 
                        setTimeout(() => reject(new Error('Request timeout')), timeout)
                    )
                ]);
            };
            
            fetchWithTimeout('/api/metrics/status', {})
            .then(response => {
                if (!response.ok) {
                    throw new Error(`HTTP error ${response.status}`);
                }
                return response.json();
            })
            .then(data => {
                updateMetricsStatus(data);
            })
            .catch(error => {
                console.error('Error fetching metrics status:', error);
                
                // Show detailed error state on failure
                document.getElementById('metrics-collection-status').textContent = 'Error';
                document.getElementById('metrics-collection-status').className = 'badge bg-danger';
                document.getElementById('metrics-collection-indicator').className = 'alert-indicator alert-critical';
                
                document.getElementById('syncservice-status').textContent = 'Disconnected';
                document.getElementById('syncservice-status').className = 'badge bg-danger';
                document.getElementById('syncservice-indicator').className = 'alert-indicator alert-critical';
                
                // Show error toast with recovery instructions
                showToast('error', 'Connection Error', 'Unable to reach metrics service. Try the Health Check button to attempt recovery.');
            });
        }
        
        // Update metrics status indicators
        function updateMetricsStatus(data) {
            // Update metrics collection status
            const metricsStatusElement = document.getElementById('metrics-collection-status');
            const metricsIndicatorElement = document.getElementById('metrics-collection-indicator');
            
            let statusText, statusClass, indicatorClass;
            
            if (data.status === 'healthy') {
                statusText = 'Normal';
                statusClass = 'badge bg-success';
                indicatorClass = 'alert-indicator alert-normal';
            } else if (data.status === 'warning') {
                statusText = 'Warning';
                statusClass = 'badge bg-warning';
                indicatorClass = 'alert-indicator alert-warning';
            } else {
                statusText = 'Error';
                statusClass = 'badge bg-danger';
                indicatorClass = 'alert-indicator alert-critical';
            }
            
            metricsStatusElement.textContent = statusText;
            metricsStatusElement.className = statusClass;
            metricsIndicatorElement.className = indicatorClass;
            
            // Update SyncService status
            const syncStatusElement = document.getElementById('syncservice-status');
            const syncIndicatorElement = document.getElementById('syncservice-indicator');
            
            if (data.syncservice_available) {
                syncStatusElement.textContent = 'Connected';
                syncStatusElement.className = 'badge bg-success';
                syncIndicatorElement.className = 'alert-indicator alert-normal';
            } else {
                syncStatusElement.textContent = 'Disconnected';
                syncStatusElement.className = 'badge bg-danger';
                syncIndicatorElement.className = 'alert-indicator alert-critical';
            }
            
            // Show last collection time and stats
            const lastUpdated = new Date(data.timestamp);
            const statusMessage = `${data.message}. Last collection: ${new Date(data.last_collection).toLocaleTimeString() || 'Never'}`;
            
            // Show toast notification with status details
            showToast(data.status, 'Metrics Status', statusMessage);
        }
        
        // Manual metrics refresh button
        document.getElementById('refresh-metrics-btn').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Refreshing...';
            
            // Call the refresh API endpoint with timeout
            fetchWithTimeout('/api/metrics/refresh', {
                method: 'POST'
            }, 8000)
            .then(response => response.json())
            .then(data => {
                // Show toast notification for metrics refresh
                showToast('healthy', 'Metrics Refresh', 'Metrics collection initiated successfully. The page will refresh shortly.');
                
                // Add a short delay before checking status to allow metrics collection to complete
                setTimeout(() => {
                    fetchMetricsStatus();
                    
                    // After a short delay, reload the page to get the new metrics data
                    setTimeout(() => {
                        window.location.reload();
                    }, 1000);
                }, 1000);
            })
            .catch(error => {
                console.error('Error refreshing metrics:', error);
                showToast('error', 'Metrics Refresh Failed', 'Unable to refresh metrics. Please try again or check system logs.');
            })
            .finally(() => {
                // Reset button state after 3 seconds regardless of outcome
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = 'Force Refresh';
                }, 3000);
            });
        });
        
        // Service Health Check and Auto-Recovery Button
        document.getElementById('health-check-btn').addEventListener('click', function() {
            const button = this;
            button.disabled = true;
            button.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Checking...';
            
            // Show initial notification
            showToast('warning', 'Health Check Started', 'Running comprehensive health check and recovery...');
            
            // Call the health check API endpoint with error handling and timeout
            fetchWithTimeout('/api/service/health-check', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            }, 10000) // Longer timeout for health check since it might restart services
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Determine status message based on health check results
                    let statusTitle = 'Health Check Complete';
                    let statusMessage = data.message || 'Service health check completed successfully.';
                    let statusType = data.status === 'healthy' ? 'healthy' : 'warning';
                    
                    // Show toast notification with health check results
                    showToast(statusType, statusTitle, statusMessage);
                    
                    // After a short delay, reload the page to get the updated status
                    setTimeout(() => {
                        window.location.reload();
                    }, 2000);
                } else {
                    // Show error toast if health check failed
                    showToast('error', 'Health Check Failed', data.message || 'Health check failed. Please check system logs.');
                }
            })
            .catch(error => {
                console.error('Error running health check:', error);
                showToast('error', 'Health Check Error', 'An error occurred during service health check. Please check system logs.');
            })
            .finally(() => {
                // Reset button state after 3 seconds regardless of outcome
                setTimeout(() => {
                    button.disabled = false;
                    button.innerHTML = '<i class="bi bi-wrench-adjustable"></i> Health Check';
                }, 3000);
            });
        });
        
        // Initially fetch metrics status on page load
        fetchMetricsStatus();
        
        // Refresh metrics status every 30 seconds
        setInterval(fetchMetricsStatus, 30000);
        
        // Function to show toast notifications
        function showToast(status, title, message) {
            // Get toast elements
            const toastElement = document.getElementById('metricsToast');
            const toastIcon = document.getElementById('toast-icon');
            const toastTitle = document.getElementById('toast-title');
            const toastMessage = document.getElementById('toast-message');
            const toastTime = document.getElementById('toast-time');
            
            // Update toast content based on status
            toastTitle.textContent = title;
            toastMessage.textContent = message;
            toastTime.textContent = new Date().toLocaleTimeString();
            
            // Set icon and color based on status
            if (status === 'healthy') {
                toastIcon.className = 'bi bi-check-circle-fill me-1 text-success';
            } else if (status === 'warning') {
                toastIcon.className = 'bi bi-exclamation-triangle-fill me-1 text-warning';
            } else {
                toastIcon.className = 'bi bi-x-circle-fill me-1 text-danger';
            }
            
            // Create Bootstrap Toast instance and show it
            const toast = new bootstrap.Toast(toastElement);
            toast.show();
        }
    });
    </script>
</body>
</html>