{% extends 'base.html' %}

{% block title %}County Property Assessment - Onboarding Tutorial{% endblock %}

{% block styles %}
<style>
    .tutorial-container {
        max-width: 1000px;
        margin: 0 auto;
        padding: 20px;
        background-color: #fff;
        border-radius: 8px;
        box-shadow: 0 4px 12px rgba(0,0,0,0.1);
        position: relative;
    }
    
    .tutorial-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
    }
    
    .tutorial-title {
        font-size: 24px;
        color: #003366;
        margin: 0;
    }
    
    .role-badge {
        background-color: #005099;
        color: white;
        padding: 5px 10px;
        border-radius: 4px;
        font-size: 14px;
        font-weight: bold;
    }
    
    .tutorial-progress {
        display: flex;
        align-items: center;
        margin-bottom: 25px;
    }
    
    .progress-dots {
        display: flex;
        flex-grow: 1;
        margin: 0 15px;
    }
    
    .progress-dot {
        width: 12px;
        height: 12px;
        border-radius: 50%;
        background-color: #ddd;
        margin: 0 5px;
    }
    
    .progress-dot.active {
        background-color: #005099;
    }
    
    .progress-dot.completed {
        background-color: #28a745;
    }
    
    .progress-label {
        font-size: 14px;
        color: #666;
    }
    
    .tutorial-content {
        display: flex;
        flex-wrap: wrap;
        margin-bottom: 30px;
    }
    
    .tutorial-image {
        flex: 0 0 40%;
        text-align: center;
    }
    
    .tutorial-image img {
        max-width: 100%;
        height: auto;
        border-radius: 8px;
    }
    
    .tutorial-text {
        flex: 0 0 58%;
        padding-left: 2%;
    }
    
    .tutorial-description {
        font-size: 16px;
        line-height: 1.6;
        color: #444;
        margin-bottom: 20px;
    }
    
    .tutorial-actions {
        background-color: #f8f9fa;
        border-radius: 8px;
        padding: 15px;
        margin-bottom: 20px;
    }
    
    .action-item {
        display: flex;
        align-items: center;
        margin-bottom: 10px;
        padding: 10px;
        border-radius: 4px;
        background-color: #fff;
        border-left: 4px solid #005099;
    }
    
    .action-icon {
        margin-right: 10px;
        color: #005099;
    }
    
    .action-description {
        font-size: 14px;
        color: #333;
    }
    
    .tutorial-navigation {
        display: flex;
        justify-content: space-between;
        margin-top: 30px;
        padding-top: 20px;
        border-top: 1px solid #eee;
    }
    
    .dismiss-link {
        color: #666;
        font-size: 14px;
        text-decoration: underline;
    }
    
    .fixed-overlay {
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        background-color: rgba(0,0,0,0.5);
        z-index: 1000;
        display: flex;
        justify-content: center;
        align-items: center;
    }
    
    .highlight-element {
        position: absolute;
        border: 2px solid #ffc107;
        background-color: rgba(255, 193, 7, 0.1);
        border-radius: 4px;
        z-index: 999;
        pointer-events: none;
    }
    
    /* Responsive adjustments */
    @media (max-width: 768px) {
        .tutorial-content {
            flex-direction: column;
        }
        
        .tutorial-image, .tutorial-text {
            flex: 0 0 100%;
            padding-left: 0;
        }
        
        .tutorial-image {
            margin-bottom: 20px;
        }
    }
</style>
{% endblock %}

{% block content %}
<div class="container my-4">
    <div class="tutorial-container" id="tutorial-container">
        <div class="tutorial-header">
            <h1 class="tutorial-title">{{ tutorial.title }}</h1>
            <span class="role-badge">{{ role }} Tutorial</span>
        </div>
        
        <div class="tutorial-progress">
            <span class="progress-label">Progress:</span>
            <div class="progress-dots">
                {% for i in range(1, total_steps + 1) %}
                    {% if i < current_step %}
                        <div class="progress-dot completed" data-step="{{ i }}"></div>
                    {% elif i == current_step %}
                        <div class="progress-dot active" data-step="{{ i }}"></div>
                    {% else %}
                        <div class="progress-dot" data-step="{{ i }}"></div>
                    {% endif %}
                {% endfor %}
            </div>
            <span class="progress-label">Step {{ current_step }} of {{ total_steps }}</span>
        </div>
        
        <div class="tutorial-content">
            <div class="tutorial-image">
                <img src="{{ url_for('static', filename='images/onboarding/' + tutorial.image) }}" alt="{{ tutorial.title }}" id="tutorial-image">
            </div>
            
            <div class="tutorial-text">
                <div class="tutorial-description">
                    {{ tutorial.description }}
                </div>
                
                {% if tutorial.actions %}
                <div class="tutorial-actions">
                    <h4>What to do:</h4>
                    {% for action in tutorial.actions %}
                        <div class="action-item" data-action-type="{{ action.type }}" data-target="{{ action.element }}">
                            <div class="action-icon">
                                {% if action.type == 'click' %}
                                <i class="fas fa-mouse-pointer"></i>
                                {% elif action.type == 'highlight' %}
                                <i class="fas fa-search"></i>
                                {% else %}
                                <i class="fas fa-info-circle"></i>
                                {% endif %}
                            </div>
                            <div class="action-description">
                                {{ action.description }}
                            </div>
                        </div>
                    {% endfor %}
                </div>
                {% endif %}
            </div>
        </div>
        
        <div class="tutorial-navigation">
            {% if current_step > 1 %}
            <a href="{{ url_for('onboarding_bp.tutorial_step', role=role, step=current_step-1) }}" class="btn btn-outline-secondary">
                <i class="fas fa-arrow-left me-2"></i> Previous
            </a>
            {% else %}
            <div></div>  <!-- Empty div for spacing -->
            {% endif %}
            
            <a href="#" class="dismiss-link" id="dismiss-tutorial">Skip tutorial</a>
            
            <button class="btn btn-primary" id="next-button">
                {{ tutorial.button_text }} <i class="fas fa-arrow-right ms-2"></i>
            </button>
        </div>
    </div>
</div>

<!-- Overlay for focusing on UI elements -->
<div class="fixed-overlay" id="tutorial-overlay" style="display:none;">
    <div class="highlight-element" id="highlight-box"></div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Handle next button click
        const nextButton = document.getElementById('next-button');
        nextButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            // Mark current step as completed
            fetch('{{ url_for("onboarding_bp.mark_step_completed", step=current_step) }}', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    if (data.completed) {
                        // Onboarding is complete, redirect to dashboard
                        window.location.href = data.redirect;
                    } else {
                        // Go to next step
                        window.location.href = data.redirect;
                    }
                }
            })
            .catch(error => {
                console.error('Error:', error);
            });
        });
        
        // Handle dismiss tutorial
        const dismissButton = document.getElementById('dismiss-tutorial');
        dismissButton.addEventListener('click', function(e) {
            e.preventDefault();
            
            if (confirm('Are you sure you want to skip the tutorial? You can restart it later from your profile settings.')) {
                fetch('{{ url_for("onboarding_bp.dismiss_onboarding") }}', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-Requested-With': 'XMLHttpRequest'
                    }
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        window.location.href = data.redirect;
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                });
            }
        });
        
        // Handle actions (highlighting and clicking)
        const actionItems = document.querySelectorAll('.action-item');
        const overlay = document.getElementById('tutorial-overlay');
        const highlightBox = document.getElementById('highlight-box');
        
        actionItems.forEach(item => {
            item.addEventListener('mouseover', function() {
                const actionType = this.getAttribute('data-action-type');
                const targetSelector = this.getAttribute('data-target');
                
                if (actionType === 'highlight' || actionType === 'click') {
                    try {
                        const targetElement = document.querySelector(targetSelector);
                        if (targetElement) {
                            highlight(targetElement);
                        }
                    } catch (error) {
                        console.warn('Cannot find element:', targetSelector);
                    }
                }
            });
            
            item.addEventListener('mouseout', function() {
                hideHighlight();
            });
        });
        
        function highlight(element) {
            const rect = element.getBoundingClientRect();
            
            overlay.style.display = 'block';
            highlightBox.style.width = rect.width + 'px';
            highlightBox.style.height = rect.height + 'px';
            highlightBox.style.top = rect.top + 'px';
            highlightBox.style.left = rect.left + 'px';
        }
        
        function hideHighlight() {
            overlay.style.display = 'none';
        }
        
        // Check for fallback image if the primary image doesn't exist
        const tutorialImage = document.getElementById('tutorial-image');
        tutorialImage.onerror = function() {
            // If the role-specific image doesn't exist, use a generic fallback
            this.src = "{{ url_for('static', filename='images/onboarding/generic_step.svg') }}";
        };
    });
</script>
{% endblock %}