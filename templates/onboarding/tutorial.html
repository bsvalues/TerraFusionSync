{% extends "base.html" %}

{% block title %}TerraFusion - Interactive Tutorial{% endblock %}

{% block styles %}
  {{ super() }}
  <style>
    .onboarding-container {
      max-width: 800px;
      margin: 0 auto;
      padding: 2rem;
    }
    
    .onboarding-header {
      text-align: center;
      margin-bottom: 2rem;
    }
    
    .onboarding-welcome {
      display: flex;
      flex-direction: column;
      align-items: center;
      margin-bottom: 3rem;
    }
    
    .welcome-image {
      width: 250px;
      height: auto;
      margin-bottom: 1.5rem;
    }
    
    .role-badge {
      display: inline-block;
      padding: 0.25rem 0.75rem;
      border-radius: 1rem;
      font-size: 0.875rem;
      font-weight: 600;
      margin-bottom: 1rem;
    }
    
    .role-badge.ITAdmin { background-color: #4299e1; color: white; }
    .role-badge.Assessor { background-color: #48bb78; color: white; }
    .role-badge.Staff { background-color: #ed8936; color: white; }
    .role-badge.Auditor { background-color: #9f7aea; color: white; }
    .role-badge.default { background-color: #a0aec0; color: white; }
    
    .tutorial-steps {
      margin-top: 2rem;
    }
    
    .step-item {
      display: flex;
      margin-bottom: 1.5rem;
      padding: 1rem;
      border-radius: 0.5rem;
      border: 1px solid #e2e8f0;
      background-color: #f7fafc;
      position: relative;
    }
    
    .step-item.completed {
      border-color: #48bb78;
      background-color: #f0fff4;
    }
    
    .step-number {
      display: flex;
      justify-content: center;
      align-items: center;
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background-color: #a0aec0;
      color: white;
      font-weight: 600;
      margin-right: 1rem;
      flex-shrink: 0;
    }
    
    .step-item.completed .step-number {
      background-color: #48bb78;
    }
    
    .step-content {
      flex-grow: 1;
    }
    
    .step-title {
      font-weight: 600;
      font-size: 1.125rem;
      margin-bottom: 0.5rem;
    }
    
    .step-description {
      color: #4a5568;
      margin-bottom: 1rem;
    }
    
    .step-status {
      position: absolute;
      top: 1rem;
      right: 1rem;
      font-size: 0.875rem;
    }
    
    .start-btn, .continue-btn, .completed-btn {
      display: inline-block;
      padding: 0.5rem 1rem;
      border-radius: 0.25rem;
      font-weight: 600;
      text-align: center;
      cursor: pointer;
    }
    
    .start-btn {
      background-color: #4299e1;
      color: white;
    }
    
    .continue-btn {
      background-color: #48bb78;
      color: white;
    }
    
    .completed-btn {
      background-color: #a0aec0;
      color: white;
      cursor: not-allowed;
    }
    
    .progress-bar-container {
      width: 100%;
      height: 10px;
      background-color: #e2e8f0;
      border-radius: 5px;
      margin-top: 2rem;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background-color: #4299e1;
      transition: width 0.3s ease;
    }
    
    .dismiss-tutorial {
      text-align: center;
      margin-top: 2rem;
      font-size: 0.875rem;
    }
    
    .dismiss-btn {
      color: #a0aec0;
      text-decoration: underline;
      cursor: pointer;
    }
    
    .dismiss-btn:hover {
      color: #718096;
    }
  </style>
{% endblock %}

{% block content %}
  <div class="onboarding-container">
    <div class="onboarding-header">
      <h1>Interactive Tutorial</h1>
      <span class="role-badge {{ role }}">{{ role }}</span>
    </div>
    
    <div class="onboarding-welcome">
      <img src="{{ url_for('static', filename='images/onboarding/' + (welcome_message.image if welcome_message else 'default_welcome.svg')) }}" 
           alt="Welcome" class="welcome-image">
      <p>{{ welcome_message.message if welcome_message else 'Welcome to the TerraFusion interactive tutorial!' }}</p>
    </div>
    
    <div class="progress-bar-container">
      <div class="progress-bar" style="width: {{ onboarding.get_progress_percentage() }}%;"></div>
    </div>
    
    <div class="tutorial-steps">
      <h2>Tutorial Steps</h2>
      
      {% for i, step in enumerate(steps, 1) %}
        {% set completed = i|string in onboarding.progress_dict %}
        {% set current = i == onboarding.current_step %}
        
        <div class="step-item {{ 'completed' if completed else '' }}">
          <div class="step-number">{{ i }}</div>
          <div class="step-content">
            <div class="step-title">{{ step.title }}</div>
            <div class="step-description">{{ step.description }}</div>
            
            {% if completed %}
              <a href="{{ url_for('onboarding_bp.view_step', step_number=i) }}" class="completed-btn">Completed</a>
            {% elif current %}
              <a href="{{ url_for('onboarding_bp.view_step', step_number=i) }}" class="start-btn">Start</a>
            {% elif i < onboarding.current_step %}
              <a href="{{ url_for('onboarding_bp.view_step', step_number=i) }}" class="continue-btn">Review</a>
            {% else %}
              <span class="start-btn" style="opacity: 0.5; cursor: not-allowed;">Locked</span>
            {% endif %}
          </div>
          
          {% if completed %}
            <div class="step-status">âœ“ Completed</div>
          {% elif current %}
            <div class="step-status">Current Step</div>
          {% endif %}
        </div>
      {% endfor %}
    </div>
    
    {% if not onboarding.tutorial_complete %}
      <div class="dismiss-tutorial">
        <a href="#" class="dismiss-btn" onclick="dismissTutorial()">Dismiss tutorial (you can restart it later)</a>
      </div>
    {% endif %}
  </div>
  
  <script>
    function dismissTutorial() {
      if (confirm('Are you sure you want to dismiss the tutorial? You can restart it later from your profile.')) {
        fetch('{{ url_for("onboarding_bp.dismiss_onboarding") }}', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            window.location.href = '{{ url_for("dashboard") }}';
          } else {
            alert('Failed to dismiss tutorial: ' + (data.error || 'Unknown error'));
          }
        })
        .catch(error => {
          console.error('Error:', error);
          alert('An error occurred while dismissing the tutorial.');
        });
      }
    }
  </script>
{% endblock %}